<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ü¶û Stanley ‚Äî Session Recovery Dashboard</title>
<link rel="stylesheet" href="nav.css">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0d1117;--card:#161b22;--border:#30363d;--text:#c9d1d9;--text-dim:#8b949e;--blue:#58a6ff;--green:#3fb950;--orange:#f0883e;--red:#f85149;--purple:#bc8cff}
body{font-family:system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);padding:20px;max-width:1400px;margin:0 auto}
h1{color:var(--blue);font-size:24px;margin-bottom:4px}
.subtitle{color:var(--text-dim);margin-bottom:20px;font-size:14px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:16px;margin-bottom:20px}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px;overflow:hidden}
.card h2{font-size:16px;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.card h2 .icon{font-size:20px}
.badge{display:inline-block;padding:2px 10px;border-radius:12px;font-size:12px;font-weight:600}
.badge-green{background:#3fb95022;color:var(--green)}
.badge-red{background:#f8514922;color:var(--red)}
.badge-orange{background:#f0883e22;color:var(--orange)}
.badge-blue{background:#58a6ff22;color:var(--blue)}
.badge-purple{background:#bc8cff22;color:var(--purple)}
.metric{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border)}
.metric:last-child{border-bottom:none}
.metric-label{color:var(--text-dim);font-size:13px}
.metric-value{font-weight:600;font-size:14px}
.progress-bar{width:100%;height:8px;background:var(--border);border-radius:4px;margin-top:4px;overflow:hidden}
.progress-fill{height:100%;border-radius:4px;transition:width 0.5s}
.agent-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border)}
.agent-row:last-child{border-bottom:none}
.agent-name{font-weight:600;font-size:14px}
.agent-meta{color:var(--text-dim);font-size:12px}
.cron-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);font-size:13px}
.cron-row:last-child{border-bottom:none}
.cron-name{font-weight:600;color:var(--text)}
.cron-next{color:var(--text-dim)}
.cron-status{font-size:11px}
.log-entry{padding:6px 0;border-bottom:1px solid var(--border);font-size:13px;line-height:1.4}
.log-entry:last-child{border-bottom:none}
.log-time{color:var(--text-dim);font-size:11px;margin-right:6px}
.log-text{color:var(--text)}
.error{color:var(--red)}
.refresh-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.refresh-btn{background:var(--blue);color:var(--bg);border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px}
.refresh-btn:hover{opacity:0.9}
.refresh-btn:disabled{opacity:0.5;cursor:not-allowed}
.last-refresh{color:var(--text-dim);font-size:12px}
.health-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:8px}
.health-item{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px;text-align:center}
.health-item .status{font-size:24px;margin-bottom:4px}
.health-item .label{font-size:11px;color:var(--text-dim)}
.full-width{grid-column:1/-1}
.tabs{display:flex;gap:8px;margin-bottom:12px}
.tab{background:var(--bg);border:1px solid var(--border);padding:6px 14px;border-radius:8px;cursor:pointer;font-size:12px;color:var(--text-dim)}
.tab.active{background:var(--blue);color:var(--bg);border-color:var(--blue)}
.tab-content{display:none}
.tab-content.active{display:block}
.empty{color:var(--text-dim);font-style:italic;padding:20px;text-align:center}
</style>
</head>
<body>
<script src="nav.js"></script>

<h1>ü¶û Stanley ‚Äî Session Recovery Dashboard</h1>
<p class="subtitle">System state at a glance. Survives compaction.</p>

<div class="refresh-bar">
  <button class="refresh-btn" onclick="refreshAll()" id="refresh-btn">‚Üª Refresh All</button>
  <span class="last-refresh" id="last-refresh">Never refreshed</span>
</div>

<!-- Health Overview -->
<div class="card full-width" style="margin-bottom:16px">
  <h2><span class="icon">ü´Ä</span> System Health</h2>
  <div class="health-grid" id="health-grid">
    <div class="health-item"><div class="status" id="h-gateway">‚è≥</div><div class="label">Gateway</div></div>
    <div class="health-item"><div class="status" id="h-api">‚è≥</div><div class="label">Kanban API</div></div>
    <div class="health-item"><div class="status" id="h-tickets">‚è≥</div><div class="label">Tickets API</div></div>
    <div class="health-item"><div class="status" id="h-dashboard">‚è≥</div><div class="label">Command Center</div></div>
    <div class="health-item"><div class="status" id="h-uploader">‚è≥</div><div class="label">File Uploader</div></div>
  </div>
</div>

<div class="grid">
  <!-- Session Info -->
  <div class="card">
    <h2><span class="icon">üß†</span> Current Session</h2>
    <div id="session-info"><div class="empty">Click Refresh to load</div></div>
  </div>

  <!-- Sub-Agents -->
  <div class="card">
    <h2><span class="icon">ü§ñ</span> Active Sub-Agents</h2>
    <div id="agents-list"><div class="empty">Click Refresh to load</div></div>
  </div>

  <!-- Cron Jobs -->
  <div class="card">
    <h2><span class="icon">‚è∞</span> Cron Jobs</h2>
    <div class="tabs">
      <div class="tab active" onclick="switchTab('cron','all')">All</div>
      <div class="tab" onclick="switchTab('cron','upcoming')">Next Up</div>
      <div class="tab" onclick="switchTab('cron','failed')">Failed</div>
    </div>
    <div id="cron-all" class="tab-content active"></div>
    <div id="cron-upcoming" class="tab-content"></div>
    <div id="cron-failed" class="tab-content"></div>
  </div>

  <!-- Recent Context -->
  <div class="card">
    <h2><span class="icon">üìã</span> Recent Context</h2>
    <div class="tabs">
      <div class="tab active" onclick="switchTab('ctx','tasks')">Tasks</div>
      <div class="tab" onclick="switchTab('ctx','calendar')">Calendar</div>
      <div class="tab" onclick="switchTab('ctx','log')">Session Log</div>
    </div>
    <div id="ctx-tasks" class="tab-content active"></div>
    <div id="ctx-calendar" class="tab-content"></div>
    <div id="ctx-log" class="tab-content"></div>
  </div>

  <!-- Tickets Summary -->
  <div class="card">
    <h2><span class="icon">üé´</span> Ticket Summary</h2>
    <div id="ticket-summary"><div class="empty">Click Refresh to load</div></div>
  </div>

  <!-- Anticipation -->
  <div class="card">
    <h2><span class="icon">üîÆ</span> Anticipation Findings</h2>
    <div id="anticipation"><div class="empty">Click Refresh to load</div></div>
  </div>
</div>

<!-- Quick Links -->
<div class="card full-width" style="margin-top:0">
  <h2><span class="icon">üîó</span> Quick Links</h2>
  <div style="display:flex;gap:12px;flex-wrap:wrap">
    <a href="https://kanban-vercel-kappa.vercel.app?token=matt2026stanley" target="_blank" class="refresh-btn" style="text-decoration:none">üìã Task Board</a>
    <a href="https://kanban-vercel-kappa.vercel.app/tickets.html?token=matt2026stanley" target="_blank" class="refresh-btn" style="text-decoration:none">üé´ Tickets</a>
    <a href="https://stanley-dashboard.vercel.app?token=matt2026stanley" target="_blank" class="refresh-btn" style="text-decoration:none">üß† Command Center</a>
    <a href="https://file-uploader-psi-two.vercel.app" target="_blank" class="refresh-btn" style="text-decoration:none">üìÇ File Uploader</a>
  </div>
</div>

<script>
const TOKEN = new URLSearchParams(window.location.search).get('token') || 'matt2026stanley';
const KANBAN_API = 'https://kanban-vercel-kappa.vercel.app/api';

function q(url) { return url + (url.includes('?') ? '&' : '?') + `token=${TOKEN}`; }

async function checkHealth(id, url) {
  const el = document.getElementById(id);
  try {
    const res = await fetch(url, { signal: AbortSignal.timeout(5000) });
    el.textContent = res.ok ? '‚úÖ' : '‚ö†Ô∏è';
  } catch { el.textContent = '‚ùå'; }
}

async function loadTickets() {
  try {
    const res = await fetch(q(`${KANBAN_API}/tickets`));
    const tickets = await res.json();
    const byStatus = {};
    tickets.forEach(t => { byStatus[t.status] = (byStatus[t.status]||0) + 1; });
    
    const statusColors = {queued:'blue',triage:'orange',ready:'blue',executing:'green',blocked:'red',review:'orange',done:'green',dropped:'purple'};
    const statusIcons = {queued:'üì•',triage:'üîç',ready:'üü¶',executing:'‚ö°',blocked:'üö´',review:'üëÅ',done:'‚úÖ',dropped:'üóë'};
    
    let html = `<div class="metric"><span class="metric-label">Total</span><span class="metric-value">${tickets.length}</span></div>`;
    Object.entries(byStatus).sort((a,b) => b[1]-a[1]).forEach(([s,c]) => {
      html += `<div class="metric"><span class="metric-label">${statusIcons[s]||''} ${s}</span><span class="badge badge-${statusColors[s]||'blue'}">${c}</span></div>`;
    });
    
    // P1 tickets
    const p1s = tickets.filter(t => t.priority === 1 && t.status !== 'done');
    if (p1s.length) {
      html += `<div style="margin-top:12px;padding-top:8px;border-top:1px solid var(--border)"><div style="color:var(--red);font-weight:600;font-size:12px;margin-bottom:6px">‚ö†Ô∏è Open P1s</div>`;
      p1s.forEach(t => { html += `<div style="font-size:12px;padding:3px 0;color:var(--text-dim)">${t.title}</div>`; });
      html += '</div>';
    }
    document.getElementById('ticket-summary').innerHTML = html;
  } catch(e) { document.getElementById('ticket-summary').innerHTML = `<div class="empty error">Failed: ${e.message}</div>`; }
}

async function loadTasks() {
  try {
    const res = await fetch(q(`${KANBAN_API}/tasks`));
    const tasks = await res.json();
    const high = tasks.filter(t => t.priority === 'high' || t.priority === 'urgent');
    if (!high.length) { document.getElementById('ctx-tasks').innerHTML = '<div class="empty">No high-priority tasks</div>'; return; }
    let html = '';
    high.slice(0, 10).forEach(t => {
      const badge = t.priority === 'urgent' ? 'red' : 'orange';
      html += `<div class="metric"><span class="metric-label">${t.title || t.text}</span><span class="badge badge-${badge}">${t.priority}</span></div>`;
    });
    if (high.length > 10) html += `<div style="color:var(--text-dim);font-size:12px;padding-top:8px">+${high.length-10} more</div>`;
    document.getElementById('ctx-tasks').innerHTML = html;
  } catch(e) { document.getElementById('ctx-tasks').innerHTML = `<div class="empty error">Failed: ${e.message}</div>`; }
}

function loadSession() {
  // Session info from what we can infer client-side
  const now = new Date();
  const html = `
    <div class="metric"><span class="metric-label">Dashboard loaded</span><span class="metric-value">${now.toLocaleString()}</span></div>
    <div class="metric"><span class="metric-label">Token</span><span class="metric-value">${TOKEN.slice(0,8)}...</span></div>
    <div class="metric"><span class="metric-label">Page</span><span class="metric-value">Session Recovery</span></div>
    <div class="metric"><span class="metric-label">Status</span><span class="badge badge-green">Active</span></div>
  `;
  document.getElementById('session-info').innerHTML = html;
}

function loadAgents() {
  // Can't query clawdbot sessions from browser ‚Äî show instructions
  document.getElementById('agents-list').innerHTML = `
    <div class="empty">Sub-agent data requires CLI access.<br><br>
    <code style="font-size:11px;color:var(--blue)">Ask Stanley: "list active sub-agents"</code></div>`;
}

function loadCalendar() {
  document.getElementById('ctx-calendar').innerHTML = `
    <div class="empty">Calendar data requires CLI access.<br><br>
    <code style="font-size:11px;color:var(--blue)">gcalcli agenda "today" "next week"</code></div>`;
}

function loadSessionLog() {
  document.getElementById('ctx-log').innerHTML = `
    <div class="empty">Session log requires file access.<br><br>
    <code style="font-size:11px;color:var(--blue)">memory/session-log.md</code></div>`;
}

function loadAnticipation() {
  document.getElementById('anticipation').innerHTML = `
    <div class="empty">Anticipation data requires CLI access.<br><br>
    <code style="font-size:11px;color:var(--blue)">bash scripts/anticipation-engine.sh --engine all</code></div>`;
}

function loadCrons() {
  // Static cron list from what we know
  const crons = [
    {name:'morning-notecard',expr:'6:30 AM',status:'ok'},
    {name:'evening-notecard',expr:'8:30 PM',status:'ok'},
    {name:'heartbeat-refresh',expr:'6:25 AM/8:25 PM',status:'ok'},
    {name:'morning-briefing',expr:'7:00 AM',status:'ok'},
    {name:'meeting-prep',expr:'hourly 8-5',status:'ok'},
    {name:'kaizen-daily',expr:'2:00 AM',status:'ok'},
    {name:'kaizen-delta',expr:'5:30 AM',status:'ok'},
    {name:'nightly-build',expr:'1:00 AM',status:'ok'},
    {name:'resilience-check',expr:'every 6h',status:'ok'},
    {name:'upload-processor',expr:'every 15m',status:'ok'},
    {name:'anticipation-scan',expr:'11 AM/3 PM',status:'ok'},
    {name:'dashboard-health',expr:'6:00 AM',status:'ok'},
  ];
  
  let allHtml = '', upcomingHtml = '', failedHtml = '';
  crons.forEach(c => {
    const row = `<div class="cron-row"><span class="cron-name">${c.name}</span><span class="cron-next">${c.expr}</span><span class="cron-status badge badge-green">ok</span></div>`;
    allHtml += row;
  });
  upcomingHtml = '<div class="empty">Requires CLI access for next-run times</div>';
  failedHtml = '<div class="empty">No recent failures detected</div>';
  
  document.getElementById('cron-all').innerHTML = allHtml;
  document.getElementById('cron-upcoming').innerHTML = upcomingHtml;
  document.getElementById('cron-failed').innerHTML = failedHtml;
}

function switchTab(group, tab) {
  document.querySelectorAll(`[id^="${group}-"]`).forEach(el => el.classList.remove('active'));
  document.querySelectorAll(`.tabs .tab`).forEach(el => {
    // Only affect tabs in the right group
  });
  document.getElementById(`${group}-${tab}`).classList.add('active');
  // Update tab buttons
  const card = document.getElementById(`${group}-${tab}`).closest('.card');
  card.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  card.querySelectorAll('.tab').forEach(t => {
    if (t.textContent.toLowerCase().replace(/\s/g,'') === tab || 
        (tab === 'all' && t.textContent === 'All') ||
        (tab === 'upcoming' && t.textContent === 'Next Up') ||
        (tab === 'failed' && t.textContent === 'Failed') ||
        (tab === 'tasks' && t.textContent === 'Tasks') ||
        (tab === 'calendar' && t.textContent === 'Calendar') ||
        (tab === 'log' && t.textContent === 'Session Log'))
      t.classList.add('active');
  });
}

async function refreshAll() {
  const btn = document.getElementById('refresh-btn');
  btn.disabled = true;
  btn.textContent = '‚Üª Refreshing...';
  
  // Health checks
  checkHealth('h-gateway', q(`${KANBAN_API}/tasks`));
  checkHealth('h-api', q(`${KANBAN_API}/tasks`));
  checkHealth('h-tickets', q(`${KANBAN_API}/tickets`));
  checkHealth('h-dashboard', 'https://stanley-dashboard.vercel.app');
  checkHealth('h-uploader', 'https://file-uploader-psi-two.vercel.app');
  
  // Data loads
  loadSession();
  loadAgents();
  loadCrons();
  loadCalendar();
  loadSessionLog();
  loadAnticipation();
  await Promise.all([loadTickets(), loadTasks()]);
  
  btn.disabled = false;
  btn.textContent = '‚Üª Refresh All';
  document.getElementById('last-refresh').textContent = `Last: ${new Date().toLocaleTimeString()}`;
}

// Auto-refresh on load
refreshAll();
// Auto-refresh every 2 minutes
setInterval(refreshAll, 120000);
</script>

</body>
</html>
